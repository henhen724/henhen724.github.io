import { graphQuery, graphSubscription } from './comms'
import { ScoutSubscription } from './ScoutSubscription'

export async function get(title: string, identifier: string, segment: string = null, language: string = 'en-US') {
  return await graphQuery(
    `
    query Player($title: String, $identifier: String, $segment: String) {
      player(title: $title, id: $identifier, segment: $segment) {
        id
        metadata {
          key
          name
          value
          displayValue
        }
        stats {
          metadata {
            key
            name
            isReversed
          }
          value
          displayValue
        }
        segments {
          metadata {
            key
            name
            value
            displayValue
          }
          stats {
            metadata {
              key
              name
              isReversed
            }
            value
            displayValue
          }
        }
      }
    }
    `, {
      title,
      identifier,
      segment
    }, (data: any) => data.player, language
  )
}

export function subscribe(title: string, identifier: string, segment: string = null, language: string = 'en-US') : ScoutSubscription {
  return graphSubscription(
    `
    query Player($title: String, $identifier: String, $segment: String) {
      player(title: $title, id: $identifier, segment: $segment) {
        id
        metadata {
          key
          name
          value
          displayValue
        }
        stats {
          metadata {
            key
            name
            isReversed
          }
          value
          displayValue
        }
        segments {
          metadata {
            key
            name
            value
            displayValue
          }
          stats {
            metadata {
              key
              name
              isReversed
            }
            value
            displayValue
          }
        }
      }
    }
    `, {
      title,
      identifier,
      segment
    },
    (data: any) => data.player,
    language
  )
}

export async function search(identifier: string, platform?: string, console?: string, title?: string, comprehensive: boolean = true, exact: boolean = false) {
  return await graphQuery(
    `
    query Search($platform: String, $console: String, $title: String, $identifier: String, $comprehensive: Boolean, $exact: Boolean) {
      players(platform: $platform, console: $console, title: $title, identifier: $identifier, comprehensive: $comprehensive, exact: $exact) {
        results {
          player {
            playerId
            handle
          }
          persona {
            id
            handle
            pictureUrl
            countryCode
            region
            isVerified
            platform {
              slug
              name
            }
          }
        }
      }
    }
    `, {
      platform,
      console,
      title,
      identifier,
      comprehensive,
      exact
    },
    (data: any) => data.players
  )
}
